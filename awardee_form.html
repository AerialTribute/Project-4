<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scholarship Reimbursement Form</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-check-compat.js"></script>

    <!-- Your Google reCAPTCHA v3 site key -->
    <script src="https://www.google.com/recaptcha/api.js?render=6Ldt6g0sAAAAAIG78mZ76kGFXoLAF63Yfz54T6j1"></script>

    <style>
        body { font-family: Arial, sans-serif; background:#fafafa; margin:0; }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        label { font-weight: bold; display:block; margin-top:15px; }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 8px; border:1px solid #ccc; border-radius:5px;
        }
        input[type="file"] { margin-top: 8px; }
        button {
            margin-top: 25px; padding: 12px 25px;
            background:#007bff; color:white; border:none;
            border-radius:5px; cursor:pointer; font-size:16px;
        }
        button:hover { background:#0056b3; }
        #statusMessage { margin-top:20px; font-size:16px; }
    </style>
</head>

<body>

<div class="container">
    <h2>Scholarship: Reimbursement Form</h2>

    <form id="reimbursementForm">

        <label>Full Name</label>
        <input type="text" id="fullName" required>

        <label>Pilot Certificate Number</label>
        <input type="text" id="certificateNumber" required>

        <label>Date of Lesson</label>
        <input type="date" id="lessonDate" required>

        <label>CFI Rate (per hour)</label>
        <input type="number" id="cfiRate" required>

        <label>Total CFI Hours Charged</label>
        <input type="number" id="cfiHours" required>

        <label>Reimbursement Amount ($)</label>
        <input type="number" id="reimbursementAmount" readonly>

        <label>Upload Logbook Photo</label>
        <input type="file" id="logbookPhoto" accept="image/*" required>

        <label>Upload Receipt</label>
        <input type="file" id="receiptPhoto" accept="image/*" required>

        <button type="submit">Submit</button>
    </form>

    <div id="statusMessage"></div>
</div>

<script>
    // -----------------------------
    // Initialize Firebase
    // -----------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyAjumS9NrNMHnjCDq0UFDKCEK1ViXkmSTQ",
        authDomain: "aerialtributeprojectforms.firebaseapp.com",
        projectId: "aerialtributeprojectforms",
        storageBucket: "aerialtributeprojectforms.appspot.com",
        messagingSenderId: "570972716430",
        appId: "1:570972716430:web:bcc02cab64d03dbef76e16"
    };

    const app = firebase.initializeApp(firebaseConfig);

    // -----------------------------
    // APP CHECK (Monitoring Mode)
    // -----------------------------
    const appCheck = firebase.appCheck();
    appCheck.activate(
        "6Ldt6g0sAAAAAIG78mZ76kGFXoLAF63Yfz54T6j1",
        true  // <-- Monitoring mode (NOT enforced)
    );

    const db = firebase.firestore();
    const storage = firebase.storage();

    // -----------------------------
    // Auto-calc reimbursement
    // -----------------------------
    document.getElementById("cfiRate").addEventListener("input", updateAmount);
    document.getElementById("cfiHours").addEventListener("input", updateAmount);

    function updateAmount() {
        const rate = parseFloat(document.getElementById("cfiRate").value) || 0;
        const hours = parseFloat(document.getElementById("cfiHours").value) || 0;
        document.getElementById("reimbursementAmount").value = (rate * hours).toFixed(2);
    }

    // -----------------------------
    // Form Submit Handler
    // -----------------------------
    document.getElementById("reimbursementForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        document.getElementById("statusMessage").innerText = "Uploading... Please wait.";

        try {
            const fullName = document.getElementById("fullName").value;
            const certNum = document.getElementById("certificateNumber").value;
            const lessonDate = document.getElementById("lessonDate").value;
            const cfiRate = document.getElementById("cfiRate").value;
            const cfiHours = document.getElementById("cfiHours").value;
            const amount = document.getElementById("reimbursementAmount").value;

            // Files
            const logbookFile = document.getElementById("logbookPhoto").files[0];
            const receiptFile = document.getElementById("receiptPhoto").files[0];

            // Upload files
            const logbookRef = storage.ref(`logbooks/${Date.now()}-${logbookFile.name}`);
            await logbookRef.put(logbookFile);
            const logbookURL = await logbookRef.getDownloadURL();

            const receiptRef = storage.ref(`receipts/${Date.now()}-${receiptFile.name}`);
            await receiptRef.put(receiptFile);
            const receiptURL = await receiptRef.getDownloadURL();

            // Save Firestore
            await db.collection("reimbursements").add({
                fullName,
                certNum,
                lessonDate,
                cfiRate,
                cfiHours,
                amount,
                logbookURL,
                receiptURL,
                submittedAt: new Date()
            });

            document.getElementById("statusMessage").innerHTML =
                "<span style='color:green;'>Form submitted successfully!</span>";

        } catch (err) {
            console.error(err);
            document.getElementById("statusMessage").innerHTML =
                "<span style='color:red;'>Error submitting form. Check console.</span>";
        }
    });
</script>

</body>
</html>
